<!DOCTYPE html>
<html>
<link href="css/bootstrap.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css">
<script src="https://unpkg.com/vue@next"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
        crossorigin="anonymous"></script>
<style>
    .footer {
        position: fixed;
        left: 0;
        bottom: 0;
        width: 100%;
        color: white;
        text-align: center;
    }
</style>
<body>
<div id="counter">
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="bi bi-cpu-fill"></i> Cypher <small style="font-size:50%;">An Epignosis bot</small></span>
            <button v-if="jwt" type="submit" @click="logout" class="btn btn-danger mb-2">Logout
            </button>
        </div>
    </nav>
    <div class="container-fluid">
        <div v-if="errorMessage" class="row">
            <div class="alert alert-warning alert-dismissible fade show col mt-3">
                <p>{{ errorMessage }}</p>
            </div>
        </div>
        <div v-if="jwt==''" class="row">
            <div class="col-md-5 offset-md-3 mt-5">
                <form>
                    <div class="form-group row">
                        <label for="staticEmail" class="col-sm-2 col-form-label">Username</label>
                        <div class="col-sm-10">
                            <input type="text" v-model="username" placeholder="Username" class="form-control"
                                   id="staticEmail" value="">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="inputPassword" class="col-sm-2 col-form-label">Password</label>
                        <div class="col-sm-10">
                            <input type="password" v-model="password" class="form-control" id="inputPassword"
                                   placeholder="Password">
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-sm-8 offset-md-5">
                            <button type="submit" @click="submitLoginForm" class="btn btn-primary mb-2">Confirm
                                identity
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div v-if="jwt !=''" class="row">
            <div class="col-md-8 offset-md-2 mt-5">
                <div>
                    <input v-model="question" placeholder="How can I help?" @change="search()"
                           class="form-control form-control-lg" type="text" placeholder=".form-control-lg"
                           aria-label=".form-control-lg example">
                    <hr>
                    <div class="row" v-if="relevantQ">
                        <div class="col">
                            <p class="lead">Most Relevant Question</p>
                            <b>{{ relevantQ }}</b>
                            <hr>
                        </div>
                    </div>
                    <div class="row" v-if="relevantA">
                        <div class="col">
                            <p class="lead">Answer</p>
                            <b>{{ relevantA }}</b>
                            <hr>
                        </div>
                    </div>
                    <div class="row" v-if="responseData">
                        <div class="col">
                            <p class="lead">Related questions</p>
                            <ul id="related-q-list">
                                <li v-for="(item, index) in responseData"><a href="javascript:void(0)"
                                                                             @click="handleLinkClick(item[0])">{{ item[0] }}</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <p>v1.0.0-pericles</p>
        </div>
    </div>
</div>
</body>

<script>
    const RFP_BOT = {
        data() {
            return {
                question: '',
                answer: '',
                relevantQ: '',
                relevantA: '',
                responseData: '',
                jwt: '',
                username: '',
                password: '',
                errorMessage: ''
            }
        },
        methods: {
            logout() {
                this.jwt = '';
                localStorage.jwt = '';
            },
            search() {
                console.log(localStorage);
                const headers = {
                    headers: {
                        'Authorization': "JWT " + this.jwt
                    }
                };
                axios.get('http://34.107.68.82:8000/?question=' + this.question, headers).then(
                    response => (this.relevantQ = response['data'][0][0], this.relevantA = response['data'][0][1], this.responseData = response['data'])
                )
            },
            handleLinkClick(item) {
                this.question = item;
                this.search()
            },
            submitLoginForm(e) {
                e.preventDefault();
                const credentials = {username: this.username, password: this.password};
                this.errorMessage = '';
                axios.post("http://34.107.68.82:8000/auth", credentials)
                    .then(response => (this.jwt = response.data.access_token, localStorage.jwt = response.data.access_token))
                    .catch(error => {
                        this.errorMessage = error.message;
                        console.error("There was an error!", error);
                    });
            }
        },
        mounted() {
            if (localStorage.jwt) {
                this.jwt = localStorage.jwt;
            }
        }
    };


    Vue.createApp(RFP_BOT).mount('#counter')


</script>
</html>